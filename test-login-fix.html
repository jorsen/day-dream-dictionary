<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login API Connection Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîß Login API Connection Test</h1>
    
    <div class="test-container">
        <h2>API Configuration Test</h2>
        <div id="config-status" class="status info">Loading configuration...</div>
        <button onclick="testConfig()">Test Config</button>
    </div>

    <div class="test-container">
        <h2>API Endpoints Test</h2>
        <div id="api-status" class="status info">Click to test API endpoints...</div>
        <button onclick="testAllAPIs()">Test All API Endpoints</button>
        <button onclick="testPrimaryAPI()">Test Primary API Only</button>
    </div>

    <div class="test-container">
        <h2>Login Test</h2>
        <div id="login-status" class="status info">Ready to test login...</div>
        <button onclick="testLogin()">Test Login with Sample User</button>
    </div>

    <div class="test-container">
        <h2>Detailed Results</h2>
        <pre id="results">Test results will appear here...</pre>
    </div>

    <script src="config.js"></script>
    <script>
        let results = [];

        function log(message) {
            results.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('results').textContent = results.join('\n');
        }

        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function testConfig() {
            log('=== Testing API Configuration ===');
            log(`Current hostname: ${window.location.hostname}`);
            log(`Is localhost: ${window.location.hostname === 'localhost'}`);
            log(`Primary API URL: ${API_CONFIG.API_BASE_URL}`);
            log(`Fallback URLs: ${API_CONFIG.FALLBACK_URLS ? API_CONFIG.FALLBACK_URLS.join(', ') : 'None'}`);
            
            updateStatus('config-status', '‚úÖ Configuration loaded successfully', 'success');
        }

        async function testAPIEndpoint(url, endpointName) {
            try {
                log(`\n--- Testing ${endpointName}: ${url} ---`);
                
                const healthResponse = await fetch(`${url}/health`, {
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                log(`Health check status: ${healthResponse.status}`);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    log(`Health check response: ${JSON.stringify(healthData)}`);
                    
                    // Test auth endpoint
                    const authResponse = await fetch(`${url}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: 'test@example.com', password: 'test' }),
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    log(`Auth endpoint status: ${authResponse.status}`);
                    
                    if (authResponse.status === 401 || authResponse.status === 400) {
                        log(`‚úÖ ${endpointName} is working (auth endpoint responding correctly)`);
                        return { success: true, url, message: 'Working' };
                    } else {
                        const authData = await authResponse.json();
                        log(`Auth response: ${JSON.stringify(authData)}`);
                        return { success: true, url, message: 'Working' };
                    }
                } else {
                    log(`‚ùå ${endpointName} health check failed`);
                    return { success: false, url, message: `Health check failed: ${healthResponse.status}` };
                }
            } catch (error) {
                log(`‚ùå ${endpointName} error: ${error.message}`);
                return { success: false, url, message: error.message };
            }
        }

        async function testAllAPIs() {
            log('\n=== Testing All API Endpoints ===');
            updateStatus('api-status', 'Testing all endpoints...', 'info');
            
            const urls = [API_CONFIG.API_BASE_URL];
            if (API_CONFIG.FALLBACK_URLS) {
                urls.push(...API_CONFIG.FALLBACK_URLS);
            }
            
            let workingCount = 0;
            const results = [];
            
            for (let i = 0; i < urls.length; i++) {
                const result = await testAPIEndpoint(urls[i], `API ${i + 1}`);
                results.push(result);
                if (result.success) workingCount++;
            }
            
            const workingAPIs = results.filter(r => r.success);
            if (workingAPIs.length > 0) {
                updateStatus('api-status', `‚úÖ ${workingAPIs.length} of ${urls.length} APIs working`, 'success');
                log(`\n‚úÖ SUCCESS: Found ${workingAPIs.length} working API(s)`);
                workingAPIs.forEach(api => log(`  - ${api.url}: ${api.message}`));
            } else {
                updateStatus('api-status', `‚ùå All ${urls.length} APIs failed`, 'error');
                log(`\n‚ùå FAILED: All APIs are down`);
                results.forEach(api => log(`  - ${api.url}: ${api.message}`));
            }
        }

        async function testPrimaryAPI() {
            log('\n=== Testing Primary API Only ===');
            updateStatus('api-status', 'Testing primary API...', 'info');
            
            const result = await testAPIEndpoint(API_CONFIG.API_BASE_URL, 'Primary API');
            
            if (result.success) {
                updateStatus('api-status', `‚úÖ Primary API working`, 'success');
                log(`\n‚úÖ Primary API is working: ${result.url}`);
            } else {
                updateStatus('api-status', `‚ùå Primary API failed`, 'error');
                log(`\n‚ùå Primary API failed: ${result.message}`);
            }
        }

        async function testLogin() {
            log('\n=== Testing Login Flow ===');
            updateStatus('login-status', 'Testing login...', 'info');
            
            const urls = [API_CONFIG.API_BASE_URL];
            if (API_CONFIG.FALLBACK_URLS) {
                urls.push(...API_CONFIG.FALLBACK_URLS);
            }
            
            let loginSuccess = false;
            let workingUrl = null;
            
            for (const url of urls) {
                try {
                    log(`\nTrying login with: ${url}/auth/login`);
                    
                    const response = await fetch(`${url}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: 'sample1@gmail.com', 
                            password: 'sample' 
                        }),
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    log(`Login response status: ${response.status}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ Login successful!`);
                        log(`User: ${JSON.stringify(data.user, null, 2)}`);
                        loginSuccess = true;
                        workingUrl = url;
                        break;
                    } else {
                        const errorData = await response.json();
                        log(`Login failed: ${errorData.message}`);
                        
                        // If we get a proper error response (not a network error), the API is working
                        if (response.status === 401 || response.status === 400) {
                            log(`‚úÖ API is working (login endpoint responding)`);
                            loginSuccess = true;
                            workingUrl = url;
                            break;
                        }
                    }
                } catch (error) {
                    log(`Network error with ${url}: ${error.message}`);
                }
            }
            
            if (loginSuccess) {
                updateStatus('login-status', `‚úÖ Login API working`, 'success');
                log(`\n‚úÖ LOGIN TEST PASSED: API is accessible at ${workingUrl}`);
            } else {
                updateStatus('login-status', `‚ùå Login API failed`, 'error');
                log(`\n‚ùå LOGIN TEST FAILED: No working API endpoints found`);
            }
        }

        // Auto-run config test on load
        window.onload = () => {
            testConfig();
        };
    </script>
</body>
</html>
