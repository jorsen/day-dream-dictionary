<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade - Day Dream Dictionary</title>
    <!-- Allow Stripe.js scripts and iframes -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline'; frame-src https://js.stripe.com; connect-src 'self' https://day-dream-dictionary.onrender.com https://api.stripe.com https://r.stripe.com https://merchant-ui-api.stripe.com; img-src 'self' data: https:; font-src 'self' https:;">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 760px; margin: 0 auto; }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            padding: 40px;
            margin-top: 20px;
        }

        h1 { color: #333; font-size: 26px; text-align: center; margin-bottom: 8px; }
        .subtitle { color: #666; text-align: center; margin-bottom: 32px; }

        /* Plan cards */
        .plans { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }

        @media (max-width: 520px) { .plans { grid-template-columns: 1fr; } }

        .plan {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .plan:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102,126,234,0.2); }
        .plan.selected { border-color: #667eea; background: #f8f9ff; }
        .plan.popular::before {
            content: 'Most Popular';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 12px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .plan-name { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 6px; }
        .plan-price { font-size: 28px; font-weight: 800; color: #667eea; margin-bottom: 4px; }
        .plan-price span { font-size: 14px; color: #888; font-weight: 400; }
        .plan-desc { font-size: 13px; color: #666; margin-bottom: 14px; }

        .plan-features { list-style: none; }
        .plan-features li { font-size: 13px; color: #555; padding: 3px 0; }
        .plan-features li::before { content: "✓ "; color: #4CAF50; font-weight: 700; }

        /* Payment form */
        #payment-section { display: none; }

        .selected-plan-banner {
            background: #f0f4ff;
            border: 1px solid #c7d4ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #4a5568;
        }

        .selected-plan-banner strong { color: #667eea; }

        label { display: block; font-size: 14px; font-weight: 500; color: #333; margin-bottom: 6px; }

        #card-element {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            transition: border-color 0.2s;
        }

        #card-element.StripeElement--focus { border-color: #667eea; }
        #card-element.StripeElement--invalid { border-color: #e53e3e; }

        #card-errors { color: #e53e3e; font-size: 13px; margin-top: 6px; min-height: 18px; }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s, transform 0.2s;
        }

        .btn:hover:not(:disabled) { opacity: 0.92; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info    { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .stripe-badge {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: #999;
        }

        .back-link { text-align: center; margin-top: 24px; }
        .back-link a { color: #667eea; text-decoration: none; font-weight: 500; }
        .back-link a:hover { text-decoration: underline; }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.5);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Upgrade Your Dream Experience</h1>
            <p class="subtitle">Unlock unlimited interpretations and premium insights</p>

            <!-- Plan selection -->
            <div class="plans">
                <div class="plan" id="plan-basic" onclick="selectPlan('basic')">
                    <div class="plan-name">Basic</div>
                    <div class="plan-price">$4.99<span>/month</span></div>
                    <div class="plan-desc">For casual dreamers</div>
                    <ul class="plan-features">
                        <li>20 deep interpretations/month</li>
                        <li>Full dream history</li>
                        <li>Symbol insights</li>
                        <li>Cancel anytime</li>
                    </ul>
                </div>

                <div class="plan popular" id="plan-pro" onclick="selectPlan('pro')">
                    <div class="plan-name">Pro</div>
                    <div class="plan-price">$12.99<span>/month</span></div>
                    <div class="plan-desc">For dedicated journalers</div>
                    <ul class="plan-features">
                        <li>100 deep interpretations/month</li>
                        <li>Full dream history</li>
                        <li>Advanced analytics</li>
                        <li>Priority support</li>
                    </ul>
                </div>
            </div>

            <!-- Payment form (shown after plan selected) -->
            <div id="payment-section">
                <div class="selected-plan-banner">
                    Subscribing to <strong id="selected-plan-label">Basic — $4.99/month</strong>
                </div>

                <div>
                    <label for="card-element">Card details</label>
                    <div id="card-element"></div>
                    <div id="card-errors"></div>
                </div>

                <button class="btn" id="subscribe-btn" onclick="handleSubscribe()">
                    Subscribe Now
                </button>

                <div class="stripe-badge">Secured by Stripe. Your card info never touches our servers.</div>
            </div>

            <div id="status" class="status"></div>

            <div class="back-link">
                <a href="profile-dashboard.html">← Back to Dashboard</a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = API_CONFIG.API_BASE_URL;
        const token   = localStorage.getItem('accessToken');

        let stripe        = null;
        let cardElement   = null;
        let selectedPlan  = null;

        // Redirect to login if not authenticated
        if (!token) {
            window.location.href = 'login.html';
        }

        async function init() {
            try {
                const res  = await fetch(`${API_URL}/config/stripe-key`);
                const data = await res.json();
                if (!data.publishableKey) throw new Error('No publishable key');

                stripe      = Stripe(data.publishableKey);
                const elements = stripe.elements();

                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            '::placeholder': { color: '#aab7c4' }
                        },
                        invalid: { color: '#e53e3e' }
                    }
                });

                cardElement.mount('#card-element');

                cardElement.on('change', ({ error }) => {
                    document.getElementById('card-errors').textContent = error ? error.message : '';
                });

            } catch (err) {
                showStatus('Payment system unavailable. Please try again later.', 'error');
                console.error('[payment] init error:', err);
            }
        }

        function selectPlan(plan) {
            selectedPlan = plan;

            document.getElementById('plan-basic').classList.toggle('selected', plan === 'basic');
            document.getElementById('plan-pro').classList.toggle('selected', plan === 'pro');

            const labels = { basic: 'Basic — $4.99/month', pro: 'Pro — $12.99/month' };
            document.getElementById('selected-plan-label').textContent = labels[plan];
            document.getElementById('payment-section').style.display = 'block';
            document.getElementById('payment-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function handleSubscribe() {
            if (!selectedPlan) { showStatus('Please select a plan.', 'error'); return; }
            if (!stripe || !cardElement) { showStatus('Payment system not ready.', 'error'); return; }

            setLoading(true);

            try {
                // 1. Create payment method from card element
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    setLoading(false);
                    return;
                }

                // 2. Send to backend
                const res = await fetch(`${API_URL}/subscriptions/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        plan: selectedPlan,
                        paymentMethodId: paymentMethod.id,
                    }),
                });

                const data = await res.json();

                if (!res.ok) {
                    showStatus(data.error || 'Subscription failed. Please try again.', 'error');
                    setLoading(false);
                    return;
                }

                // 3. Handle 3-D Secure if required
                if (data.clientSecret) {
                    const { error: confirmError } = await stripe.confirmCardPayment(data.clientSecret);
                    if (confirmError) {
                        showStatus(confirmError.message, 'error');
                        setLoading(false);
                        return;
                    }
                }

                showStatus('Subscription activated! Redirecting to dashboard...', 'success');
                setTimeout(() => { window.location.href = 'profile-dashboard.html'; }, 2000);

            } catch (err) {
                console.error('[payment] subscribe error:', err);
                showStatus('Something went wrong. Please try again.', 'error');
                setLoading(false);
            }
        }

        function setLoading(loading) {
            const btn = document.getElementById('subscribe-btn');
            btn.disabled = loading;
            btn.innerHTML = loading
                ? '<span class="spinner"></span>Processing...'
                : 'Subscribe Now';
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
        }

        init();
    </script>
</body>
</html>
