<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrade & Credits - Day Dream Dictionary</title>
    <!-- Allow Stripe.js scripts and iframes -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://js.stripe.com; style-src 'self' 'unsafe-inline'; frame-src https://js.stripe.com; connect-src 'self' https://day-dream-dictionary.onrender.com https://api.stripe.com https://r.stripe.com https://merchant-ui-api.stripe.com; img-src 'self' data: https:; font-src 'self' https:;">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="config.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 760px; margin: 0 auto; }

        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            padding: 40px;
            margin-top: 20px;
        }

        h1 { color: #333; font-size: 26px; text-align: center; margin-bottom: 8px; }
        .subtitle { color: #666; text-align: center; margin-bottom: 32px; }

        /* Plan cards */
        .plans { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }

        @media (max-width: 520px) { .plans { grid-template-columns: 1fr; } }

        .plan {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .plan:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102,126,234,0.2); }
        .plan.selected { border-color: #667eea; background: #f8f9ff; }
        .plan.popular::before {
            content: 'Most Popular';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #667eea;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 12px;
            border-radius: 20px;
            white-space: nowrap;
        }

        .plan-name { font-size: 18px; font-weight: 700; color: #333; margin-bottom: 6px; }
        .plan-price { font-size: 28px; font-weight: 800; color: #667eea; margin-bottom: 4px; }
        .plan-price span { font-size: 14px; color: #888; font-weight: 400; }
        .plan-desc { font-size: 13px; color: #666; margin-bottom: 14px; }

        .plan-features { list-style: none; }
        .plan-features li { font-size: 13px; color: #555; padding: 3px 0; }
        .plan-features li::before { content: "‚úì "; color: #4CAF50; font-weight: 700; }

        /* Payment form */
        #payment-section { display: none; }

        .selected-plan-banner {
            background: #f0f4ff;
            border: 1px solid #c7d4ff;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #4a5568;
        }

        .selected-plan-banner strong { color: #667eea; }

        label { display: block; font-size: 14px; font-weight: 500; color: #333; margin-bottom: 6px; }

        #card-element {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            transition: border-color 0.2s;
        }

        #card-element.StripeElement--focus { border-color: #667eea; }
        #card-element.StripeElement--invalid { border-color: #e53e3e; }

        #card-errors { color: #e53e3e; font-size: 13px; margin-top: 6px; min-height: 18px; }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: opacity 0.2s, transform 0.2s;
        }

        .btn:hover:not(:disabled) { opacity: 0.92; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

        .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error   { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info    { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .stripe-badge {
            text-align: center;
            margin-top: 12px;
            font-size: 12px;
            color: #999;
        }

        .back-link { text-align: center; margin-top: 24px; }
        .back-link a { color: #667eea; text-decoration: none; font-weight: 500; }
        .back-link a:hover { text-decoration: underline; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 28px;
        }
        .tab-btn {
            padding: 10px 22px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 15px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            margin-bottom: -2px;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Credit packs */
        .packs { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 24px; }
        @media(max-width:540px){ .packs { grid-template-columns: 1fr; } }
        .pack {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .pack:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 6px 16px rgba(102,126,234,.18); }
        .pack.selected { border-color: #667eea; background: #f8f9ff; }
        .pack.best-value::before {
            content: 'Best Value';
            position: absolute; top: -11px; left: 50%; transform: translateX(-50%);
            background: #667eea; color: white; font-size: 11px; font-weight: 700;
            padding: 2px 10px; border-radius: 20px; white-space: nowrap;
        }
        .pack-credits { font-size: 28px; font-weight: 800; color: #667eea; }
        .pack-credits span { font-size: 14px; color: #888; font-weight: 400; }
        .pack-price { font-size: 17px; font-weight: 700; color: #333; margin-top: 4px; }
        .pack-per { font-size: 12px; color: #aaa; margin-top: 2px; }

        /* Add-ons */
        .addons-grid { display: grid; gap: 12px; margin-bottom: 24px; }
        .addon-item {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px 18px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .addon-item:hover { border-color: #667eea; }
        .addon-item.selected { border-color: #667eea; background: #f8f9ff; }
        .addon-item.owned { border-color: #4CAF50; background: #f0fdf4; cursor: default; pointer-events: none; }
        .addon-item.owned:hover { transform: none; box-shadow: none; }
        .addon-icon { font-size: 24px; }
        .addon-info { flex: 1; }
        .addon-name { font-weight: 700; color: #333; font-size: 15px; }
        .addon-desc { font-size: 13px; color: #777; margin-top: 2px; }
        .addon-price { font-size: 15px; font-weight: 700; color: #667eea; white-space: nowrap; }
        .badge-owned { background: #d4edda; color: #155724; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.5);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Upgrade Your Dream Experience</h1>
            <p class="subtitle">Subscriptions ¬∑ Credit Packs ¬∑ Add-Ons</p>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('subscription', this)">Subscription</button>
                <button class="tab-btn" onclick="switchTab('credits', this)">Credit Packs</button>
                <button class="tab-btn" onclick="switchTab('addons', this)">Add-Ons</button>
            </div>

            <!-- ‚îÄ‚îÄ Subscription tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="tab-panel active" id="tab-subscription">

            <!-- Plan selection -->
            <div class="plans">
                <div class="plan" id="plan-basic" onclick="selectPlan('basic')">
                    <div class="plan-name">Basic</div>
                    <div class="plan-price">$4.99<span>/month</span></div>
                    <div class="plan-desc">For casual dreamers</div>
                    <ul class="plan-features">
                        <li>20 deep interpretations/month</li>
                        <li>Full dream history</li>
                        <li>Symbol insights</li>
                        <li>Cancel anytime</li>
                    </ul>
                </div>

                <div class="plan popular" id="plan-pro" onclick="selectPlan('pro')">
                    <div class="plan-name">Pro</div>
                    <div class="plan-price">$12.99<span>/month</span></div>
                    <div class="plan-desc">For dedicated journalers</div>
                    <ul class="plan-features">
                        <li>100 deep interpretations/month</li>
                        <li>Full dream history</li>
                        <li>Advanced analytics</li>
                        <li>Priority support</li>
                    </ul>
                </div>
            </div>

            <!-- Payment form (shown after plan selected) -->
            <div id="payment-section">
                <div class="selected-plan-banner">
                    Subscribing to <strong id="selected-plan-label">Basic ‚Äî $4.99/month</strong>
                </div>

                <div>
                    <label for="card-element">Card details</label>
                    <div id="card-element"></div>
                    <div id="card-errors"></div>
                </div>

                <button class="btn" id="subscribe-btn" onclick="handleSubscribe()">
                    Subscribe Now
                </button>

                <div class="stripe-badge">Secured by Stripe. Your card info never touches our servers.</div>
            </div>

            <div id="status" class="status"></div>

            </div><!-- end tab-subscription -->

            <!-- ‚îÄ‚îÄ Credit Packs tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="tab-panel" id="tab-credits">
                <p class="subtitle" style="margin-bottom:20px;">Each deep interpretation costs 3 credits. Credits never expire.</p>
                <div class="packs">
                    <div class="pack" id="pack-10" onclick="selectPack('10')">
                        <div class="pack-credits">10<span> credits</span></div>
                        <div class="pack-price">$9.99</div>
                        <div class="pack-per">$1.00 / credit</div>
                    </div>
                    <div class="pack best-value" id="pack-25" onclick="selectPack('25')">
                        <div class="pack-credits">25<span> credits</span></div>
                        <div class="pack-price">$19.99</div>
                        <div class="pack-per">$0.80 / credit</div>
                    </div>
                    <div class="pack" id="pack-60" onclick="selectPack('60')">
                        <div class="pack-credits">60<span> credits</span></div>
                        <div class="pack-price">$39.99</div>
                        <div class="pack-per">$0.67 / credit</div>
                    </div>
                </div>

                <div id="credit-payment-section" style="display:none;">
                    <div class="selected-plan-banner">
                        Purchasing <strong id="selected-pack-label">10 Credits ‚Äî $9.99</strong>
                    </div>
                    <label>Card details</label>
                    <div id="card-element-credits"></div>
                    <div id="card-errors-credits"></div>
                    <button class="btn" id="buy-credits-btn" onclick="handleCreditPurchase()">Buy Credits</button>
                    <div class="stripe-badge">Secured by Stripe.</div>
                </div>
                <div id="status-credits" class="status"></div>
            </div><!-- end tab-credits -->

            <!-- ‚îÄ‚îÄ Add-Ons tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
            <div class="tab-panel" id="tab-addons">
                <p class="subtitle" style="margin-bottom:20px;">Unlock powerful features. One-time purchase, permanent access.</p>
                <div class="addons-grid" id="addonsList">
                    <div class="addon-item" id="addon-life_season" onclick="selectAddon('life_season')">
                        <div class="addon-icon">üå±</div>
                        <div class="addon-info">
                            <div class="addon-name">Life Season</div>
                            <div class="addon-desc">Interpretation contextualized to your current life phase</div>
                        </div>
                        <div class="addon-price">$4.99</div>
                    </div>
                    <div class="addon-item" id="addon-recurring" onclick="selectAddon('recurring')">
                        <div class="addon-icon">üîÑ</div>
                        <div class="addon-info">
                            <div class="addon-name">Recurring Dreams</div>
                            <div class="addon-desc">Pattern & repetition analysis across your dream history</div>
                        </div>
                        <div class="addon-price">$2.99</div>
                    </div>
                    <div class="addon-item" id="addon-couples" onclick="selectAddon('couples')">
                        <div class="addon-icon">üíë</div>
                        <div class="addon-info">
                            <div class="addon-name">Couples</div>
                            <div class="addon-desc">Shared dream interpretation for you and your partner</div>
                        </div>
                        <div class="addon-price">$6.99</div>
                    </div>
                    <div class="addon-item" id="addon-therapist_pdf" onclick="selectAddon('therapist_pdf')">
                        <div class="addon-icon">ü©∫</div>
                        <div class="addon-info">
                            <div class="addon-name">Therapist Export</div>
                            <div class="addon-desc">Professional PDF with clinical focal points</div>
                        </div>
                        <div class="addon-price">$9.99</div>
                    </div>
                    <div class="addon-item" id="addon-ad_removal" onclick="selectAddon('ad_removal')">
                        <div class="addon-icon">üö´</div>
                        <div class="addon-info">
                            <div class="addon-name">Ad Removal</div>
                            <div class="addon-desc">Permanently remove all ads from your experience</div>
                        </div>
                        <div class="addon-price">$2.99</div>
                    </div>
                </div>

                <div id="addon-payment-section" style="display:none;">
                    <div class="selected-plan-banner">
                        Purchasing <strong id="selected-addon-label">Life Season</strong>
                    </div>
                    <label>Card details</label>
                    <div id="card-element-addons"></div>
                    <div id="card-errors-addons"></div>
                    <button class="btn" id="buy-addon-btn" onclick="handleAddonPurchase()">Purchase Add-On</button>
                    <div class="stripe-badge">Secured by Stripe. One-time charge.</div>
                </div>
                <div id="status-addons" class="status"></div>
            </div><!-- end tab-addons -->

            <div class="back-link">
                <a href="profile-dashboard.html">‚Üê Back to Dashboard</a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = API_CONFIG.API_BASE_URL;
        const token   = localStorage.getItem('accessToken');

        let stripe        = null;
        let cardElement   = null;
        let selectedPlan  = null;

        // Redirect to login if not authenticated
        if (!token) {
            window.location.href = 'login.html';
        }

        async function init() {
            try {
                const res  = await fetch(`${API_URL}/config/stripe-key`);
                const data = await res.json();
                if (!data.publishableKey) throw new Error('No publishable key');

                stripe      = Stripe(data.publishableKey);
                const elements = stripe.elements();

                cardElement = elements.create('card', {
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#32325d',
                            '::placeholder': { color: '#aab7c4' }
                        },
                        invalid: { color: '#e53e3e' }
                    }
                });

                cardElement.mount('#card-element');

                cardElement.on('change', ({ error }) => {
                    document.getElementById('card-errors').textContent = error ? error.message : '';
                });

            } catch (err) {
                showStatus('Payment system unavailable. Please try again later.', 'error');
                console.error('[payment] init error:', err);
            }
        }

        function selectPlan(plan) {
            selectedPlan = plan;

            document.getElementById('plan-basic').classList.toggle('selected', plan === 'basic');
            document.getElementById('plan-pro').classList.toggle('selected', plan === 'pro');

            const labels = { basic: 'Basic ‚Äî $4.99/month', pro: 'Pro ‚Äî $12.99/month' };
            document.getElementById('selected-plan-label').textContent = labels[plan];
            document.getElementById('payment-section').style.display = 'block';
            document.getElementById('payment-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function handleSubscribe() {
            if (!selectedPlan) { showStatus('Please select a plan.', 'error'); return; }
            if (!stripe || !cardElement) { showStatus('Payment system not ready.', 'error'); return; }

            setLoading(true);

            try {
                // 1. Create payment method from card element
                const { paymentMethod, error } = await stripe.createPaymentMethod({
                    type: 'card',
                    card: cardElement,
                });

                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    setLoading(false);
                    return;
                }

                // 2. Send to backend
                const res = await fetch(`${API_URL}/subscriptions/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        plan: selectedPlan,
                        paymentMethodId: paymentMethod.id,
                    }),
                });

                const data = await res.json();

                if (!res.ok) {
                    showStatus(data.error || 'Subscription failed. Please try again.', 'error');
                    setLoading(false);
                    return;
                }

                // 3. Handle 3-D Secure if required
                if (data.clientSecret) {
                    const { error: confirmError } = await stripe.confirmCardPayment(data.clientSecret);
                    if (confirmError) {
                        showStatus(confirmError.message, 'error');
                        setLoading(false);
                        return;
                    }
                }

                showStatus('Subscription activated! Redirecting to dashboard...', 'success');
                setTimeout(() => { window.location.href = 'profile-dashboard.html'; }, 2000);

            } catch (err) {
                console.error('[payment] subscribe error:', err);
                showStatus('Something went wrong. Please try again.', 'error');
                setLoading(false);
            }
        }

        function setLoading(loading) {
            const btn = document.getElementById('subscribe-btn');
            btn.disabled = loading;
            btn.innerHTML = loading
                ? '<span class="spinner"></span>Processing...'
                : 'Subscribe Now';
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
        }

        init();
        if (token) loadOwnedAddons();

        // ‚îÄ‚îÄ Shared state ‚Äî declared before any function or IIFE that reads them ‚îÄ
        let selectedPack       = null;
        let cardElementCredits = null;
        let selectedAddon      = null;
        let cardElementAddons  = null;

        // ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(tabId, btn) {
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            btn.classList.add('active');

            // Init Stripe elements for new tabs on first open
            if (tabId === 'credits' && !cardElementCredits && stripe) initCreditCard();
            if (tabId === 'addons'  && !cardElementAddons  && stripe) initAddonCard();
        }

        // Check hash on load to open the correct tab (e.g. payment.html#addons)
        (function() {
            const hash = window.location.hash.replace('#', '');
            if (['credits','addons'].includes(hash)) {
                const btn = document.querySelector(`.tab-btn[onclick*="${hash}"]`);
                if (btn) switchTab(hash, btn);
            }
        })();

        // ‚îÄ‚îÄ Credit pack elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initCreditCard() {
            if (!stripe || cardElementCredits) return;
            const elements = stripe.elements();
            cardElementCredits = elements.create('card', {
                style: { base: { fontSize:'16px', color:'#32325d', '::placeholder':{ color:'#aab7c4' } }, invalid:{ color:'#e53e3e' } }
            });
            cardElementCredits.mount('#card-element-credits');
            cardElementCredits.on('change', ({error}) => {
                document.getElementById('card-errors-credits').textContent = error ? error.message : '';
            });
        }

        function selectPack(pack) {
            selectedPack = pack;
            ['10','25','60'].forEach(p => document.getElementById(`pack-${p}`).classList.toggle('selected', p === pack));
            const labels = { '10':'10 Credits ‚Äî $9.99', '25':'25 Credits ‚Äî $19.99', '60':'60 Credits ‚Äî $39.99' };
            document.getElementById('selected-pack-label').textContent = labels[pack];
            const section = document.getElementById('credit-payment-section');
            section.style.display = 'block';
            section.scrollIntoView({ behavior:'smooth' });
            if (!cardElementCredits && stripe) initCreditCard();
        }

        async function handleCreditPurchase() {
            if (!selectedPack) { showStatus('Please select a credit pack.', 'error', 'credits'); return; }
            if (!stripe || !cardElementCredits) { showStatus('Payment not ready.', 'error', 'credits'); return; }

            const btn = document.getElementById('buy-credits-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Processing...';

            try {
                const { paymentMethod, error } = await stripe.createPaymentMethod({ type:'card', card:cardElementCredits });
                if (error) {
                    document.getElementById('card-errors-credits').textContent = error.message;
                    btn.disabled = false; btn.textContent = 'Buy Credits'; return;
                }

                const res  = await fetch(`${API_URL}/credits/purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
                    body: JSON.stringify({ pack: selectedPack, paymentMethodId: paymentMethod.id })
                });
                const data = await res.json();

                if (!res.ok) {
                    showStatus(data.error || 'Purchase failed.', 'error', 'credits');
                    btn.disabled = false; btn.textContent = 'Buy Credits'; return;
                }

                if (data.clientSecret) {
                    const { error: confirmError } = await stripe.confirmCardPayment(data.clientSecret);
                    if (confirmError) {
                        showStatus(confirmError.message, 'error', 'credits');
                        btn.disabled = false; btn.textContent = 'Buy Credits'; return;
                    }
                }

                showStatus(`‚úì ${data.credits} credits added to your account!`, 'success', 'credits');
                setTimeout(() => window.location.href = 'account-settings.html', 2000);
            } catch {
                showStatus('Something went wrong. Please try again.', 'error', 'credits');
                btn.disabled = false; btn.textContent = 'Buy Credits';
            }
        }

        // ‚îÄ‚îÄ Add-on elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const ADDON_META = {
            life_season:   { label:'Life Season',     price:'$4.99' },
            recurring:     { label:'Recurring Dreams', price:'$2.99' },
            couples:       { label:'Couples',          price:'$6.99' },
            therapist_pdf: { label:'Therapist Export', price:'$9.99' },
            ad_removal:    { label:'Ad Removal',       price:'$2.99' },
        };

        function initAddonCard() {
            if (!stripe || cardElementAddons) return;
            const elements = stripe.elements();
            cardElementAddons = elements.create('card', {
                style: { base: { fontSize:'16px', color:'#32325d', '::placeholder':{ color:'#aab7c4' } }, invalid:{ color:'#e53e3e' } }
            });
            cardElementAddons.mount('#card-element-addons');
            cardElementAddons.on('change', ({error}) => {
                document.getElementById('card-errors-addons').textContent = error ? error.message : '';
            });
        }

        async function loadOwnedAddons() {
            try {
                const res  = await fetch(`${API_URL}/addons`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;
                const { addons } = await res.json();
                addons.forEach(({ key }) => {
                    const el = document.getElementById(`addon-${key}`);
                    if (!el) return;
                    el.classList.add('owned');
                    // Replace price with owned badge
                    const priceEl = el.querySelector('.addon-price');
                    if (priceEl) priceEl.outerHTML = `<span class="badge-owned">‚úì Owned</span>`;
                });
            } catch { /* non-critical */ }
        }

        function selectAddon(key) {
            selectedAddon = key;
            document.querySelectorAll('.addon-item').forEach(el => el.classList.remove('selected'));
            document.getElementById(`addon-${key}`).classList.add('selected');
            const meta = ADDON_META[key];
            document.getElementById('selected-addon-label').textContent = `${meta.label} ‚Äî ${meta.price}`;
            const section = document.getElementById('addon-payment-section');
            section.style.display = 'block';
            section.scrollIntoView({ behavior:'smooth' });
            if (!cardElementAddons && stripe) initAddonCard();
        }

        async function handleAddonPurchase() {
            if (!selectedAddon) { showStatus('Please select an add-on.', 'error', 'addons'); return; }
            if (!stripe || !cardElementAddons) { showStatus('Payment not ready.', 'error', 'addons'); return; }

            const btn = document.getElementById('buy-addon-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Processing...';

            try {
                const { paymentMethod, error } = await stripe.createPaymentMethod({ type:'card', card:cardElementAddons });
                if (error) {
                    document.getElementById('card-errors-addons').textContent = error.message;
                    btn.disabled = false; btn.textContent = 'Purchase Add-On'; return;
                }

                const res  = await fetch(`${API_URL}/addons/purchase`, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` },
                    body: JSON.stringify({ addonKey: selectedAddon, paymentMethodId: paymentMethod.id })
                });
                const data = await res.json();

                if (!res.ok) {
                    showStatus(data.error || 'Purchase failed.', 'error', 'addons');
                    btn.disabled = false; btn.textContent = 'Purchase Add-On'; return;
                }

                if (data.clientSecret) {
                    const { error: confirmError } = await stripe.confirmCardPayment(data.clientSecret);
                    if (confirmError) {
                        showStatus(confirmError.message, 'error', 'addons');
                        btn.disabled = false; btn.textContent = 'Purchase Add-On'; return;
                    }
                }

                const meta = ADDON_META[selectedAddon];
                showStatus(`‚úì ${meta.label} add-on activated!`, 'success', 'addons');
                setTimeout(() => window.location.href = 'account-settings.html', 2000);
            } catch {
                showStatus('Something went wrong. Please try again.', 'error', 'addons');
                btn.disabled = false; btn.textContent = 'Purchase Add-On';
            }
        }

        // ‚îÄ‚îÄ Override showStatus to support tab namespacing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _origShowStatus = showStatus;
        function showStatus(msg, type, tab) {
            const elId = tab ? `status-${tab}` : 'status';
            const el = document.getElementById(elId) || document.getElementById('status');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
        }
    </script>
    <script src="language-selector.js"></script>
</body>
</html>
