<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Functionality Test - Day Dream Dictionary</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .test-button.success {
            background: #4CAF50;
        }
        .test-button.error {
            background: #f44336;
        }
        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .test-result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.success {
            background: #4CAF50;
        }
        .status-indicator.error {
            background: #f44336;
        }
        .status-indicator.pending {
            background: #ff9800;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .endpoint-test {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .endpoint-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .endpoint-url {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="test-header">
        <h1>üí≥ Payment System Test Suite</h1>
        <p>Comprehensive testing for Day Dream Dictionary payment functionality</p>
    </div>

    <div class="test-container">
        <h2>üîß Environment Detection</h2>
        <div class="test-section">
            <button class="test-button" onclick="detectEnvironment()">Detect Environment</button>
            <div id="environment-result" class="test-result"></div>
        </div>
    </div>

    <div class="test-container">
        <h2>üåê Payment Server Connectivity</h2>
        <div class="grid">
            <div class="endpoint-test">
                <div class="endpoint-name">Products Catalog</div>
                <div class="endpoint-url">GET /api/v1/payment/products</div>
                <button class="test-button" onclick="testPaymentEndpoint('products')">Test</button>
                <div id="products-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Payment Intent Creation</div>
                <div class="endpoint-url">POST /api/v1/payment/create-intent</div>
                <button class="test-button" onclick="testPaymentEndpoint('create-intent')">Test</button>
                <div id="create-intent-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Subscription Creation</div>
                <div class="endpoint-url">POST /api/v1/payment/create-subscription</div>
                <button class="test-button" onclick="testPaymentEndpoint('create-subscription')">Test</button>
                <div id="create-subscription-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Payment Confirmation</div>
                <div class="endpoint-url">POST /api/v1/payment/confirm</div>
                <button class="test-button" onclick="testPaymentEndpoint('confirm')">Test</button>
                <div id="confirm-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Payment Methods</div>
                <div class="endpoint-url">GET /api/v1/payment/methods</div>
                <button class="test-button" onclick="testPaymentEndpoint('methods')">Test</button>
                <div id="methods-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Webhook Handler</div>
                <div class="endpoint-url">POST /api/v1/payment/webhook</div>
                <button class="test-button" onclick="testPaymentEndpoint('webhook')">Test</button>
                <div id="webhook-result" class="test-result"></div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>üîó Main API Payment Routes</h2>
        <div class="grid">
            <div class="endpoint-test">
                <div class="endpoint-name">Credit Packs</div>
                <div class="endpoint-url">GET /api/v1/payments/credit-packs</div>
                <button class="test-button" onclick="testMainApiEndpoint('credit-packs')">Test</button>
                <div id="credit-packs-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Purchase Credits</div>
                <div class="endpoint-url">POST /api/v1/payments/purchase-credits</div>
                <button class="test-button" onclick="testMainApiEndpoint('purchase-credits')">Test</button>
                <div id="purchase-credits-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Subscription Status</div>
                <div class="endpoint-url">GET /api/v1/payments/subscription</div>
                <button class="test-button" onclick="testMainApiEndpoint('subscription')">Test</button>
                <div id="subscription-result" class="test-result"></div>
            </div>

            <div class="endpoint-test">
                <div class="endpoint-name">Payment History</div>
                <div class="endpoint-url">GET /api/v1/payments/history</div>
                <button class="test-button" onclick="testMainApiEndpoint('history')">Test</button>
                <div id="history-result" class="test-result"></div>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>üìä Test Summary</h2>
        <div class="test-section">
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <button class="test-button" onclick="clearResults()">Clear Results</button>
            <div id="summary-result" class="test-result"></div>
        </div>
    </div>

    <script>
        // Determine base URLs based on environment
        function getApiUrls() {
            const isProduction = window.location.hostname.includes('onrender.com');
            
            return {
                paymentServer: isProduction 
                    ? 'https://day-dream-dictionary-payments.onrender.com/api/v1/payment'
                    : 'http://localhost:5001/api/v1/payment',
                mainApi: isProduction
                    ? 'https://day-dream-dictionary-api.onrender.com/api/v1'
                    : 'http://localhost:5000/api/v1'
            };
        }

        function detectEnvironment() {
            const result = document.getElementById('environment-result');
            const urls = getApiUrls();
            
            const envInfo = {
                hostname: window.location.hostname,
                isProduction: window.location.hostname.includes('onrender.com'),
                paymentServerUrl: urls.paymentServer,
                mainApiUrl: urls.mainApi,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            };
            
            result.className = 'test-result info';
            result.textContent = JSON.stringify(envInfo, null, 2);
        }

        async function testPaymentEndpoint(endpoint) {
            const result = document.getElementById(`${endpoint}-result`);
            const urls = getApiUrls();
            const url = `${urls.paymentServer}/${endpoint}`;
            
            result.className = 'test-result info';
            result.textContent = 'Testing...';
            
            try {
                const startTime = Date.now();
                let response;
                let data;
                
                if (endpoint === 'products' || endpoint === 'methods') {
                    response = await fetch(url);
                    data = await response.json();
                } else if (endpoint === 'create-intent') {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: 999,
                            currency: 'usd',
                            metadata: { test: true }
                        })
                    });
                    data = await response.json();
                } else if (endpoint === 'create-subscription') {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            priceId: 'price_basic_monthly',
                            userId: 'test-user',
                            email: 'test@example.com',
                            paymentMethodId: 'pm_test'
                        })
                    });
                    data = await response.json();
                } else if (endpoint === 'confirm') {
                    // First create a payment intent
                    const createResponse = await fetch(`${urls.paymentServer}/create-intent`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amount: 999,
                            currency: 'usd'
                        })
                    });
                    const createData = await createResponse.json();
                    
                    // Then confirm it
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            paymentIntentId: createData.paymentIntentId
                        })
                    });
                    data = await response.json();
                } else if (endpoint === 'webhook') {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'payment_intent.succeeded',
                            data: { test: true }
                        })
                    });
                    data = await response.json();
                }
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const testResult = {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    statusCode: response.status,
                    responseTime: `${responseTime}ms`,
                    url: url,
                    data: data
                };
                
                result.className = response.ok ? 'test-result success' : 'test-result error';
                result.textContent = JSON.stringify(testResult, null, 2);
                
            } catch (error) {
                const errorResult = {
                    status: 'ERROR',
                    error: error.message,
                    url: url
                };
                
                result.className = 'test-result error';
                result.textContent = JSON.stringify(errorResult, null, 2);
            }
        }

        async function testMainApiEndpoint(endpoint) {
            const result = document.getElementById(`${endpoint}-result`);
            const urls = getApiUrls();
            const url = `${urls.mainApi}/payments/${endpoint}`;
            
            result.className = 'test-result info';
            result.textContent = 'Testing...';
            
            try {
                const startTime = Date.now();
                let response;
                let data;
                
                if (endpoint === 'credit-packs' || endpoint === 'subscription' || endpoint === 'history') {
                    response = await fetch(url, {
                        headers: {
                            'Authorization': 'Bearer mock-token',
                            'Content-Type': 'application/json'
                        }
                    });
                    data = await response.json();
                } else if (endpoint === 'purchase-credits') {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer mock-token',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            packSize: 'small'
                        })
                    });
                    data = await response.json();
                }
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                
                const testResult = {
                    status: response.ok ? 'SUCCESS' : 'FAILED',
                    statusCode: response.status,
                    responseTime: `${responseTime}ms`,
                    url: url,
                    data: data
                };
                
                result.className = response.ok ? 'test-result success' : 'test-result error';
                result.textContent = JSON.stringify(testResult, null, 2);
                
            } catch (error) {
                const errorResult = {
                    status: 'ERROR',
                    error: error.message,
                    url: url
                };
                
                result.className = 'test-result error';
                result.textContent = JSON.stringify(errorResult, null, 2);
            }
        }

        async function runAllTests() {
            const summary = document.getElementById('summary-result');
            summary.className = 'test-result info';
            summary.textContent = 'Running all tests...';
            
            const tests = [
                'products', 'create-intent', 'create-subscription', 'confirm', 'methods', 'webhook',
                'credit-packs', 'purchase-credits', 'subscription', 'history'
            ];
            
            const results = [];
            
            for (const test of tests) {
                if (['products', 'create-intent', 'create-subscription', 'confirm', 'methods', 'webhook'].includes(test)) {
                    await testPaymentEndpoint(test);
                } else {
                    await testMainApiEndpoint(test);
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Count results
            const successCount = document.querySelectorAll('.test-result.success').length;
            const errorCount = document.querySelectorAll('.test-result.error').length;
            const totalTests = successCount + errorCount;
            
            const finalSummary = {
                totalTests: totalTests,
                successful: successCount,
                failed: errorCount,
                successRate: totalTests > 0 ? `${Math.round((successCount / totalTests) * 100)}%` : '0%',
                timestamp: new Date().toISOString()
            };
            
            summary.className = errorCount === 0 ? 'test-result success' : 'test-result error';
            summary.textContent = JSON.stringify(finalSummary, null, 2);
        }

        function clearResults() {
            document.querySelectorAll('.test-result').forEach(result => {
                result.className = 'test-result';
                result.textContent = '';
            });
        }

        // Auto-detect environment on page load
        document.addEventListener('DOMContentLoaded', detectEnvironment);
    </script>
</body>
</html>
