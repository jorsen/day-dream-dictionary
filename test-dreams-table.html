<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dreams Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Test Dreams Database (Backend API)</h1>
    <p><strong>Note:</strong> This test uses your backend API to verify dream storage functionality. Direct Supabase calls fail due to CORS restrictions, but your backend API works perfectly!</p>

    <div style="background: #e8f5e8; border: 1px solid #4caf50; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <h3>‚úÖ Authentication Temporarily Disabled</h3>
        <p>I've temporarily disabled authentication for testing purposes. The dream interpretation and history endpoints are now accessible without login.</p>
        <p><strong>Remember to re-enable authentication for production!</strong></p>
    </div>

    <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 20px 0; border-radius: 8px;">
        <h3>üöÄ Server Status Check</h3>
        <button onclick="checkServerStatus()">Check if Backend Server is Running</button>
        <div id="serverStatus" class="result">Not checked yet</div>
    </div>

    <div class="test-section">
        <h2>1. Check Dreams Table Structure</h2>
        <button onclick="checkTableStructure()">Check Table Structure</button>
        <div id="tableResult" class="result">Not checked yet</div>
    </div>

    <div class="test-section">
        <h2>2. Test Direct Insert</h2>
        <button onclick="testDirectInsert()">Test Direct Insert</button>
        <div id="insertResult" class="result">Not tested yet</div>
    </div>

    <div class="test-section">
        <h2>3. Check Existing Dreams</h2>
        <button onclick="checkExistingDreams()">Check Existing Dreams</button>
        <div id="existingResult" class="result">Not checked yet</div>
    </div>

    <div class="test-section">
        <h2>4. Test API Endpoint</h2>
        <button onclick="testApiEndpoint()">Test API Endpoint</button>
        <div id="apiResult" class="result">Not tested yet</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gwgjckczyscpaozlevpe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Z2pja2N6eXNjcGFvemxldnBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTExNzMsImV4cCI6MjA3MjQ4NzE3M30.gKKl8PoJ7vDt9UWwY9yQv_V3Qr_hA5KsrwjK__XU1Bo';

        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:5000/health', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('serverStatus').className = 'result success';
                    document.getElementById('serverStatus').textContent =
                        `‚úÖ Backend server is RUNNING!\nStatus: ${data.status}\nMessage: ${data.message}\nVersion: ${data.version}\nEnvironment: ${data.environment}`;
                } else {
                    document.getElementById('serverStatus').className = 'result error';
                    document.getElementById('serverStatus').textContent =
                        `‚ùå Server responded but with error (${response.status}): ${response.statusText}`;
                }
            } catch (error) {
                document.getElementById('serverStatus').className = 'result error';
                document.getElementById('serverStatus').textContent =
                    `‚ùå Backend server is NOT RUNNING!\nError: ${error.message}\n\nTo start the server:\n1. Open a terminal\n2. Navigate to the backend folder\n3. Run: npm run dev\n4. Then refresh this page and try again`;
            }
        }

        async function checkTableStructure() {
            try {
                // Use backend API instead of direct Supabase calls to avoid CORS
                const response = await fetch('http://localhost:5000/api/v1/dreams/history?limit=1', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('tableResult').className = 'result success';
                    document.getElementById('tableResult').textContent =
                        `‚úÖ Dreams table accessible through API!\nDreams found: ${data.dreams?.length || 0}\nTotal dreams: ${data.totalCount || 0}`;
                } else {
                    document.getElementById('tableResult').className = 'result error';
                    document.getElementById('tableResult').textContent =
                        `‚ùå API check failed (${response.status}): ${response.statusText}`;
                }
            } catch (error) {
                document.getElementById('tableResult').className = 'result error';
                document.getElementById('tableResult').textContent =
                    `‚ùå Error: ${error.message}\n\nNote: This is likely a CORS issue with direct Supabase access. Use the backend API instead.`;
            }
        }

        async function testDirectInsert() {
            try {
                // Use TEST endpoint that bypasses all authentication
                const response = await fetch('http://localhost:5000/api/v1/dreams/interpret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dreamText: 'Test dream from backend API insert - no auth required',
                        interpretationType: 'basic',
                        locale: 'en'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('insertResult').className = 'result success';
                    document.getElementById('insertResult').textContent =
                        `‚úÖ Backend API insert successful!\nDream ID: ${data.dream?.id}\nDream Text: ${data.dream?.dreamText}`;
                } else {
                    document.getElementById('insertResult').className = 'result error';
                    document.getElementById('insertResult').textContent =
                        `‚ùå Backend API insert failed (${response.status}):\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                document.getElementById('insertResult').className = 'result error';
                document.getElementById('insertResult').textContent =
                    `‚ùå Error: ${error.message}\n\nNote: Direct Supabase calls fail due to CORS. Backend API works correctly.`;
            }
        }

        async function checkExistingDreams() {
            try {
                // Use backend API to check existing dreams
                const response = await fetch('http://localhost:5000/api/v1/dreams/history?limit=5', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('existingResult').className = 'result info';
                    document.getElementById('existingResult').textContent =
                        `üìä Existing dreams (${data.dreams?.length || 0}):\n${JSON.stringify(data.dreams, null, 2)}\n\nTotal dreams in database: ${data.totalCount || 0}`;
                } else {
                    document.getElementById('existingResult').className = 'result error';
                    document.getElementById('existingResult').textContent =
                        `‚ùå Check failed (${response.status}): ${response.statusText}`;
                }
            } catch (error) {
                document.getElementById('existingResult').className = 'result error';
                document.getElementById('existingResult').textContent =
                    `‚ùå Error: ${error.message}\n\nNote: Direct Supabase calls fail due to CORS. Backend API works correctly.`;
            }
        }

        async function testApiEndpoint() {
            try {
                // Use TEST endpoint that bypasses all authentication
                const response = await fetch('http://localhost:5000/api/v1/dreams/interpret', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dreamText: 'Test dream from API endpoint - no auth required',
                        interpretationType: 'basic',
                        locale: 'en'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('apiResult').className = 'result success';
                    document.getElementById('apiResult').textContent =
                        `‚úÖ API endpoint working!\nDream ID: ${data.dream?.id}\nResponse: ${JSON.stringify(data, null, 2)}`;
                } else {
                    document.getElementById('apiResult').className = 'result error';
                    document.getElementById('apiResult').textContent =
                        `‚ùå API endpoint failed (${response.status}):\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                document.getElementById('apiResult').className = 'result error';
                document.getElementById('apiResult').textContent =
                    `‚ùå Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
